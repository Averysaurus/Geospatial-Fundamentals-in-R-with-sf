setwd('..')
list.files()
library(sf)     # spatial objects and methods
library(tmap)   # mapping spatial objects
sfhomes <- read.csv('data/sf_properties_25ksample.csv',
sfhomes15 <- subset(sfhomes, as.numeric(SalesYear) == 2015)
sfhomes15_sf <- st_as_sf(sfhomes15, coords = c('lon', 'lat'), crs=4326)
sfhomes15_utm <- st_transform(sfhomes15_sf, st_crs(sfhighways))
bart <- read.csv("./data/bart.csv", stringsAsFactors = F)
bart_sf = st_as_sf(bart, coords = c('X', 'Y'), crs = 4326)
bart_utm <- st_transform(bart_sf, st_crs(sfhomes15_utm))
sfboundary <- st_read('./data', 'sfboundary')
sfboundary_utm <- st_transform(sfboundary, st_crs(sfhomes15_utm))
sfhighways = st_read('./data', 'sfhighways')
sftracts <- st_read("./data", "sftracts_wpop")
sftracts_utm = st_transform(sftracts, st_crs(sfhomes15_utm))
homes_with_tracts <- st_within(sfhomes15_utm, sftracts)
sfhomes15_utm$home_geoid <- sftracts_utm[unlist(homes_with_tracts),]$GEOID
sfhomes <- read.csv('data/sf_properties_25ksample.csv',)
sfhomes15 <- subset(sfhomes, as.numeric(SalesYear) == 2015)
sfhomes15_sf <- st_as_sf(sfhomes15, coords = c('lon', 'lat'), crs=4326)
sfhomes15_utm <- st_transform(sfhomes15_sf, st_crs(sfhighways))
bart <- read.csv("./data/bart.csv", stringsAsFactors = F)
bart_sf = st_as_sf(bart, coords = c('X', 'Y'), crs = 4326)
bart_utm <- st_transform(bart_sf, st_crs(sfhomes15_utm))
sfboundary <- st_read('./data', 'sfboundary')
sfboundary_utm <- st_transform(sfboundary, st_crs(sfhomes15_utm))
sfhighways = st_read('./data', 'sfhighways')
sftracts <- st_read("./data", "sftracts_wpop")
sftracts_utm = st_transform(sftracts, st_crs(sfhomes15_utm))
homes_with_tracts <- st_within(sfhomes15_utm, sftracts)
sftracts_utm = st_transform(sftracts, st_crs(sfhomes15_utm))
homes_with_tracts <- st_within(sfhomes15_utm, sftracts_utm)
sfhomes15_utm$home_geoid <- sftracts_utm[unlist(homes_with_tracts),]$GEOID
med_hh_inc <- read.csv("data/sf_med_hh_income2015.csv", stringsAsFactors = F,
colClasses = c("character","numeric"))
head(med_hh_inc)
head(med_hh_inc)
?merge
base::merge()
?base::merge()
#make sure we're using `base` `merge` (because multiple other packages
#that you might have read in also have a `merge` function)
sfhomes15_utm <- base::merge(sfhomes15_utm,
med_hh_inc, by.x="home_geoid", by.y="GEOID")
head(sfhomes15_utm, 2)
?sf::aggregate.sf
tracts_with_mean_val <- aggregate(x = sfhomes15_utm["totvalue"],
by = sftracts_utm,
FUN = mean)
class(tracts_with_mean_val)
head(tracts_with_mean_val, 2)
nrow(tracts_with_mean_val) == nrow(sftracts_utm)
sftracts_utm$mean_totvalue <- tracts_with_mean_val$totvalue
head(sftracts_utm, 2) # check it
sftracts_utm$mean_totvalue <- aggregate(x = sfhomes15_utm["totvalue"],
by = sftracts_utm,
FUN = mean)$totvalue
head(sftracts_utm, 2) # check it
choropleth =
tm_shape(sftracts_utm) +
tm_polygons(col="mean_totvalue", border.col=NA)
choropleth
choropleth + tm_shape(sfhomes15_utm) + tm_dots(col = 'totvalue')
ttm()
choropleth + tm_shape(sfhomes15_utm) + tm_dots(col = 'totvalue')
?st_buffer
#remember: our units are meters!
bart_1km_buffer <- st_buffer(sfbart_utm, dist=1000)
#remember: our units are meters!
bart_1km_buffer <- st_buffer(bart_utm, dist=1000)
tm_shape(bart_1km_buffer) + tm_polygons(col="red") +
tm_shape(sfbart_utm) + tm_dots()
sfbart_utm = bart_utm
tm_shape(bart_1km_buffer) + tm_polygons(col="red") +
tm_shape(sfbart_utm) + tm_dots()
sfbart_utm = st_intersection(bart_utm, sfboundary_utm)
tm_shape(bart_1km_buffer) + tm_polygons(col="red") +
tm_shape(sfbart_utm) + tm_dots()
#return non-sparse, to see full structure better
homes_near_bart <-  st_intersects(sfhomes15_utm, bart_1km_buffer, sparse=F)
class(homes_near_bart)
dim(homes_near_bart)
head(homes_near_bart,3)
#buffer the whole BART system as a single geometry (a multipolygon)
bart_sys_1km_buffer <- st_buffer(st_combine(sfbart_utm), dist=1000)
#intersect the BART system and the homes
homes_near_bart <-  st_intersects(sfhomes15_utm, bart_sys_1km_buffer, sparse=F)
dim(homes_near_bart)
sfhomes15_utm_near_bart <- sfhomes15_utm[unlist(homes_near_bart),]
homes_near_bart_map = tm_shape(sfboundary_utm) +
tm_polygons() +
tm_shape(bart_sys_1km_buffer) +
tm_polygons(col = 'red') +
tm_shape(sfhomes15_utm_near_bart) +
tm_dots(col = 'black', size = 0.1)
homes_near_bart_map
#Neat, huh?
tmap_last() +
tm_shape(st_intersection(sfhomes15_utm, st_buffer(bart_utm, 1000))) +
tm_dots(col = 'green', size = 0.1)
library(sf)     # simple features objects and methods
library(tmap)   # mapping spatial objects
library(raster) # reading in and operating on rasters
# Read in from CSV file
sfhomes <- read.csv('./data/sf_properties.csv',
stringsAsFactors = FALSE)
# subset the data
sfhomes15 <- subset(sfhomes, as.numeric(SalesYear) == 2015)
# coerce to an `sf` object
sfhomes15_sf <- st_as_sf(sfhomes15, coords = c('lon', 'lat'),
crs = 4326)
# Read in the 'sftracts_wpop' shapefile
sftracts <- st_read("./data", "sftracts_wpop")
#Reproject to the sftracts projection
#NOTE: We're overwriting the previous sfhomes15_sf object here! This is
#fine to do if we want, but we should always beware.
sfhomes15_sf = st_transform(sfhomes15_sf, st_crs(sftracts))
#check projection equality
st_crs(sfhomes15_sf) == st_crs(sftracts)
#read in a Bay Area DEM (Digital Elevation Model)
#(from http://www.webgis.com/terr_pages/CA/dem1/sanfrancisco.html)
DEM = raster('./data/san_francisco-e.DEM')
#plot it
plot(DEM)
DEM
DEM
class(DEM)
type(DEM)
typeof(DEM)
str(DEM)
DEM@extent
str(DEM@extent)
DEM@extent@xmin
DEM@crs
DEM@ncols
DEM
(DEM@extent@xmax - DEM@extent@xmin) / DEM@ncols
(DEM@extent@ymax - DEM@extent@ymin) / DEM@nrows
DEM
str(DEM@data)
DEM@data@values
str(DEM@data)
str(DEM@data)
DEM@data@values
str(DEM@data)
DEM@data@values
DEM[10:15, 20:30]
#coerce our whole raser's dataset to a matrix, with the appropriate number
#of columns, and
matrix(DEM[,], ncol = ncol(DEM), byrow = TRUE)
#coerce our whole raser's dataset to a matrix, with the appropriate number
#of columns, and
dim(matrix(DEM[,], ncol = ncol(DEM), byrow = TRUE))
#coerce our whole raser's dataset to a matrix, with the appropriate number
#of columns, and
raster(matrix(DEM[,], ncol = ncol(DEM), byrow = TRUE))
DEM[10:15, 20:30, drop = FALSE]
plot(DEM[10:15, 20:30, drop = FALSE]()
)))
plot(DEM[10:15, 20:30, drop = FALSE])
test@data@values
test = DEM[10:15, 20:30, drop = FALSE]
plot(test)
test@data@values
#check out its projection
proj4string(DEM)
st_crs(DEM)
st_crs(DEM)
#check out its projection
proj4string(DEM)
#reproject tracts to our DEM projection
sftracts_NAD = st_transform(sftracts, st_crs(DEM))
DEM_WGS = projectRaster(DEM, projectExtent(DEM, st_crs(sftracts)))
?projectRaster
class(crs(st_crs(sftracts)$proj4string))
DEM_WGS = projectRaster(DEM, projectExtent(DEM, crs(st_crs(sftracts)$proj4string)))
DEM_WGS
DEN
DEM
st_crs(sftracts_NAD) == st_crs(DEM)
st_crs(DEM_WGS) == st_crs(sftracts)
sfhomes15_sp = as_Spatial(sfhomes15_sf)
sfhomes15_sp
str(sfhomes15_sp)
sfhomes15_sfagain = st_as_sf(sfhomes15_sp)
plot(sfhomes15_sfagain['totvalue'])
# clip the WGS CRS version of the rasters to sftracts
DEM_WGS_crop = crop(DEM_WGS, sftracts)
# Clip the NAD CRS version
DEM_crop = crop(DEM, sftracts_NAD)
plot(DEM_WGS_crop)
plot(DEM)
plot(DEM_WGS_crop)
#plot together
plot(DEM_WGS_crop)
plot(sftracts, add = T, col = NA)
DEM_WGS_crop_masked = mask(DEM_WGS_crop, sftracts)
DEM_WGS_crop_masked
DEM_WGS_crop
plot(DEM_WGS_crop_masked)
plot(sftracts, add = T, col = NA)
my_map <- tm_shape(DEM_WGS_crop_masked) +
tm_raster() +
tm_shape(sftracts) +
tm_borders() +
# Set mode to interactive
tmap_mode("view")
my_map <- tm_shape(DEM_WGS_crop_masked) +
tm_raster() +
tm_shape(sftracts) +
tm_borders() +
# Set mode to interactive
tmap_mode("view")
my_map
#write our reprojected, cropped data to the data directory, using the Geotiff format
#(and allow R to overwrite if file already exists)
writeRaster(DEM_WGS_crop_masked, filename="./data/DEM_reproject_crop.tif", format="GTiff", overwrite = T)
list.files('./data')
# get the elevation for every cell in each of the census tracts
elev = extract(DEM_WGS_crop, sftracts)
#what did that give us?
head(elev)
length(elev)
nrow(sftracts)
mean_elev = lapply(elev, mean, na.rm = T)
head(mean_elev)
sftracts$mean_elev = unlist(mean_elev)
#what did we get?
elev_map <- tm_shape(sftracts) +
tm_polygons(col = 'mean_elev') +
tm_layout("The pain of biking in SF, by census tract",
inner.margins=c(0,0,.1,0), title.size=4.8)
elev_map
?extract
elev = extract(DEM_WGS_crop, sftracts, fun=mean)
#what did that give us?
head(elev)
#read in nlcd data
nlcd = raster('./data/nlcd2011_sf.tif')
#plot nlcd
plot(nlcd)
freq(nlcd)
barplot(nlcd)
#plot nlcd
plot(nlcd)
#check projection equality
st_crs(nlcd) == st_crs(sftracts)
#reproject
nlcd_WGS = projectRaster(nlcd, projectExtent(nlcd, crs(st_crs(sftracts)$proj4string)))
#check projection equality again
st_crs(nlcd_WGS) == st_crs(sftracts)
#crop
nlcd_WGS_crop = crop(nlcd_WGS, sftracts)
plot(nlcd_WGS_crop)
nlcd_WGS_crop@legend
nlcd@legend
nlcd_WGS_crop@legend = nlcd@legend
plot(nlcd_WGS_crop)
?reclassify
reclass_vec <- c(0, 20, NA, # water will be set to NA (i.e. 'left out' of our analysis)
20, 21, 1, # we'll treat developed open space as greenspace, based on NLCD description
21, 30, 0, # developed and hardscape will have 0s
30, 31, NA,
31, Inf, 1) # greensapce will have 1s
reclass_vec
reclass_m <- matrix(reclass_vec, ncol = 3, byrow = TRUE)
reclass_m
nlcd_green <- reclassify(nlcd_WGS_crop, reclass_m)
freq(nlcd_green)
barplot(nlcd_green)
plot(nlcd_green)
greenspace = extract(nlcd_green, sftracts, fun=mean)
greenspace
plot(nlcd)
greenspace = extract(nlcd_green, sftracts, fun=mean, na.rm = T)
sftracts$prop_greenspace = greenspace
head(sftracts)
sftracts_w_mean_val = aggregate(x = sfhomes15_sf['totvalue'],
by = sftracts,
FUN = mean)
#and add the totvalue column to our sftracts dataframe
sftracts$mean_totvalue = sftracts_w_mean_val$totvalue
qtm(sftracts_w_mean_val, fill = 'totvalue')
mod = lm(mean_totvalue ~ mean_elev + prop_greenspace, data = sftracts)
summary(mod)
sfhomes15_sample = sfhomes15_sf[sample(seq(nrow(sfhomes15_sf)),
replace = FALSE, size = 2000), ]
#reproject
sfhomes15_utm <- st_transform(sfhomes15_sample, 26910)
DEM_utm = projectRaster(DEM,
projectExtent(DEM,
crs(st_crs(sfhomes15_utm)$proj4string)))
nlcd_green_utm = projectRaster(nlcd_green,
projectExtent(nlcd_green,
crs(st_crs(sfhomes15_utm)$proj4string)))
#check projections
st_crs(sfhomes15_utm) == st_crs(DEM_utm)
st_crs(sfhomes15_utm) == st_crs(nlcd_green_utm)
#create buffer
sfhomes15_utm_buff = st_buffer(sfhomes15_utm, dist = 100)
#sum the greenspace within the buffers
#NOTE: This will take a couple minutes to run...
greenspace_homes = extract(nlcd_green_utm, sfhomes15_utm_buff, fun = mean, na.rm = T)
#add that as a column in our sfhomes15_utm dataframe
sfhomes15_utm$greenspace = greenspace_homes
#extract the elevation to the homes
#NOTE: no need for fun or na.rm arguments here, because the homes
#and points, not polygons, so only a single cell will extract to each
elev_homes = extract(DEM_utm, sfhomes15_utm)
#add that as a column in our sfhomes15_utm dataframe too
sfhomes15_utm$elev = elev_homes
mod = lm(totvalue ~ elev + greenspace, data = sfhomes15_utm)
summary(mod)
list.files('./data/CalMnYr/')
#(from http://climate.calcommons.org/dataset/monthly-summertime-fog)
#(units are in average hours per day)
karl_files = unique(gsub('.aux.xml', '', list.files('./data/CalMnYr')))
karl_files = karl_files[grep('flcc', karl_files)]
# Take  a look
karl_files
karl <- stack(paste0('./data/CalMnYr/', karl_files))
# look at what we made!
karl
#plot a few
plot(karl[[7:9]])
karl_WGS = projectRaster(karl, projectExtent(karl, crs(st_crs(sftracts)$proj4string)))
# check resulting CRS
st_crs(karl_WGS) == st_crs(sftracts)
karl_WGS
# See the documentation!
?raster::brick
# Crop it to sftracts
karl_WGS_crop = crop(karl_WGS, sftracts)
# Mean values
mean_karl_WGS_crop = mean(karl_WGS_crop)
mean_karl_WGS_crop
plot(mean_karl_WGS_crop)
plot(sftracts, add = T, col = NA)
# This won't work
sd_karl_WGS_crop = sd(karl_WGS_crop)
sd_karl_WGS_crop = calc(karl_WGS_crop, sd)
#plot that too
par(mfrow = c(1,2))
plot(mean_karl_WGS_crop)
plot(sftracts, add = T, reset=F, key.pos=NULL, col = NA)
plot(sd_karl_WGS_crop)
plot(sftracts, add = T, reset=F, key.pos=NULL, col = NA)
