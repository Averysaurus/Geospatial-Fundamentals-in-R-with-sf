tmap_mode("view")
my_map
?writeRaster
#write our reprojected, cropped data to the data directory, using the Geotiff format
#(and allow R to overwrite if file already exists)
writeRaster(DEM_WGS_crop_masked, filename="./data/DEM_reproject_crop.tif", format="GTiff", overwrite = T)
# get the elevation for every cell in each of the census tracts
elev = extract(DEM_WGS_crop, SFtracts)
#what did that give us?
head(elev)
length(elev)
nrow(SFtracts)
mean_elev = lapply(elev, mean, na.rm = T)
head(mean_elev)
unlist(mean_elev)
SFtracts$mean_elev = unlist(mean_elev)
head(SFtracts)
#what did we get?
elev_map <- tm_shape(SFtracts) +
tm_polygons(col = 'mean_elev') +
tm_layout("The pain of biking in SF, by census tract",
inner.margins=c(0,0,.1,0), title.size=4.8)
elev_map
extract
?extract
elev = extract(DEM_WGS_crop, SFtracts, fun=mean)
#what did that give us?
head(elev)
nlcd = raster('./data/nlcd2011_sf.tif')
plot(nlcd)
freq(nlcd)
barplot(nlcd)
nlcd_WGS = projectRaster(nlcd, projectExtent(nlcd, st_crs(sftracts)$proj4string))
nlcd_WGS = projectRaster(nlcd, projectExtent(nlcd, st_crs(SFtracts)$proj4string))
#check projection equality
st_crs(nlcd) == st_crs(SFtracts)
#check projection equality again
st_crs(nlcd_WGS)$epsg == st_crs(SFtracts)$epsg
#check projection equality again
st_crs(nlcd_WGS) == st_crs(SFtracts)
plot(nlcd_WGS_crop)
#crop
nlcd_WGS_crop = crop(nlcd_WGS, SFtracts)
plot(nlcd_WGS_crop)
nlcd@legend
nlcd_WGS_crop@legend
nlcd_WGS_crop@legend = nlcd@legend
plot(nlcd_WGS_crop)
#reproject again, this time using nearest-neighbor interpolation
nlcd_WGS = projectRaster(nlcd, projectExtent(nlcd, st_crs(SFtracts)$proj4string),
method='ngb')
#check projection equality again
st_crs(nlcd_WGS)$epsg == st_crs(SFtracts)$epsg
#check projection equality again
st_crs(nlcd_WGS) == st_crs(SFtracts)
#grab our legend again
nlcd_WGS_crop@legend = nlcd@legend
#plot to check again
plot(nlcd_WGS_crop)
#crop again
nlcd_WGS_crop = crop(nlcd_WGS, SFtracts)
#grab our legend again
nlcd_WGS_crop@legend = nlcd@legend
#plot to check again
plot(nlcd_WGS_crop)
?reclassify
reclass_vec <- c(0, 20, NA, # water will be set to NA (i.e. 'left out' of our analysis)
20, 21, 1, # we'll treat developed open space as greenspace, based on NLCD description
21, 30, 0, # developed and hardscape will have 0s
30, 31, NA,
31, Inf, 1) # greensapce will have 1s
reclass_vec
reclass_m <- matrix(reclass_vec, ncol = 3, byrow = TRUE)
reclass_m
nlcd_green <- reclassify(nlcd_WGS_crop, reclass_m)
nlcd_green
freq(nlcd_green)
barplot(nlcd_green)
plot(nlcd_green)
#extract the mean nlcd_simple values to tract polygons
greenspace = extract(nlcd_green, SFtracts, fun=mean)
greenspace
?raster::extract
#extract the mean nlcd_simple values to tract polygons,
#this time setting na.rm to TRUE
greenspace = extract(nlcd_green, SFtracts, fun=mean, na.rm = T)
greenspace
#and add to our SFtracts dataframe (which we can do because order is preserved)
SFtracts$prop_greenspace = greenspace
#aggregate totvalue to SFtracts
SFtracts_w_mean_val = aggregate(x = SFhomes15_sf['totvalue'],
by = SFtracts,
FUN = mean)
#and add the totvalue column to our SFtracts dataframe
SFtracts$mean_totvalue = SFtracts_w_mean_val$totvalue
qtm(SFtracts_w_mean_val, fill = 'totvalue')
#(from http://climate.calcommons.org/dataset/monthly-summertime-fog)
#(units are in average hours per day)
karl_files = unique(gsub('.aux.xml', '', list.files('./data/CalMnYr')))
karl_files = karl_files[grep('flcc', karl_files)]
# Take  a look
karl_files
paste0('./data/CalMnYr/', karl_files)
karl <- stack(paste0('./data/CalMnYr/', karl_files))
# look at what we made!
karl
#plot a few
plot(karl)
karl_WGS = projectRaster(karl, projectExtent(karl, st_crs(SFtracts)$proj4string))
# See the documentation!
?raster::brick
# Crop it to SFtracts
karl_WGS_crop = crop(karl_WGS, SFtracts)
# now let's make our same plot again
par(mfrow = c(1,2))
plot(karl_WGS[[7]])
plot(st_geometry(SFtracts), add = T, reset=F, key.pos = NULL, col = NA)
plot(karl_WGS_crop[[7]])
plot(st_geometry(SFtracts), add = T, reset = F, key.pos = NULL, col = NA)
# Mean values
mean_karl_WGS_crop = mean(karl_WGS_crop)
mean_karl_WGS_crop
plot(mean_karl_WGS_crop)
plot(st_geometry(SFtracts), add = T, col = NA)
# This won't work
sd_karl_WGS_crop = sd(karl_WGS_crop)
sd_karl_WGS_crop = calc(karl_WGS_crop, sd)
#plot that too
par(mfrow = c(1,2))
plot(mean_karl_WGS_crop, main="mean summer fog hours")
plot(st_geometry(SFtracts), add = T, reset=F, key.pos=NULL, col = NA)
plot(sd_karl_WGS_crop, main="sd summer fog hours")
plot(st_geometry(SFtracts), add = T, reset=F, key.pos=NULL, col = NA)
SFtracts$mean_karl = extract(mean_karl_WGS_crop, SFtracts, mean)
# Linear regression model
mod = lm(mean_karl ~ mean_elev, data = SFtracts)
summary(mod)
SFhomes <- read.csv('data/sf_properties_25ksample.csv',
stringsAsFactors = FALSE)
# Take a look at first 5 rows and a few of the columns
SFhomes[1:5,c("YearBuilt","totvalue","AreaSquareFeet","Neighborhood",
"NumBedrooms")]
class(SFhomes)            # what is the data object type?
dim(SFhomes)              # how many rows and columns
str(SFhomes)              # display the structure of the object
SFhomes$lon
head(SFhomes)             # take a look at the first 10 records
summary(SFhomes)          # explore the range of values
summary(SFhomes$totvalue) # explore the range of values for one column
hist(SFhomes$totvalue)    # histogram for the totvalue column
plot(SFhomes$lon, SFhomes$lat)
bart <- read.csv("./data/bart.csv")
# take a look
head (bart)
SFhomes15 <- subset(SFhomes, as.numeric(SalesYear) == 2015)
plot(SFhomes$lon, SFhomes$lat)
points(bart$X, bart$Y, col='red')
bart
plot(bart)
plot(bart$X, bart$Y)
points(SFhomes$lon, SFhomes$lat)
plot(SFhomes$lon, SFhomes$lat)
points(bart$X, bart$Y, col='red')
plot(SFhomes$lon, SFhomes$lat, asp=1)
points(bart$X, bart$Y, col='red')
landmarks <- read.csv("./data/landmarks.csv")
head(landmarks)
plot(SFhomes$lon, SFhomes$lat)
points(bart$X, bart$Y, col='red')
points(landmarks$X, landmarks$Y, col='green')
library(sf)
tracts = st_read(dsn = './data', layer = 'sftracts')
tracts
str(SFhomes)
class(tracts)
str(tracts)
nrow(tracts)
colnames(tracts)
head(tracts, 4)
plot(bart)
plot(tracts)
tracts
plot(tracts$ALAND)
plot(tracts['ALAND'])
plot(tracts[,c('ALAND')])
plot(subset(tracts, select='NAME'))
plot(subset(tracts, select='ALAND'))
plot(tracts$ALAND)
class(tracts['NAME'])
class(tracts[, 'NAME'])
class(subset(tracts, select='NAME'))
class(tracts$NAME)
plot(tracts$NAME)
tracts$ALAND
tracts$geometry
st_crs(tracts)
tracts$geometry
tracts$geometry[[1]]
class(tracts$geometry[[1]])
plot(st_geometry(tracts))
plot(tracts$geometry)
points(SFhomes15$lon, SFhomes15$lat)
as.numeric("546")
Y= st_as_sf(X)
st_crs(tracts)
st_crs("+proj=longlat +ellps=WGS84 +datum=WGS84")
st_crs("+init=epsg:4326")
st_crs(4326)
st_crs(4)
st_crs(4326)
SFhomes15_sf = st_as_sf(SFhomes15, coords = c('lon', 'lat'), crs = 4326)
SFhomes15_sf
?st_transform
tracts_lonlat = st_transform(tracts, crs=4326)
tracts_lonlat
tracts_lonlat = st_transform(tracts, crs = 4326)
tracts_lonlat = st_transform(tracts, crs = st_crs(SFhomes15_sf))
st_crs(SFhomes15_sf)
st_crs(tracts_lonlat)
st_crs(SFhomes15_sf) == st_crs(tracts_lonlat)
plot(st_geometry(tracts_lonlat))
plot(st_geometry(SFhomes15_sf), add=T, col='blue')
library(ggplot2)
ggplot() + geom_point(data=SFhomes15, aes(x=lon, y=lat, col=totvalue))
library(tmap)
qtm(SFhomes15_sf)
plot(SFhomes$lon, SFhomes$lat)
qtm(SFhomes15_sf)
tmap_mode("plot")
tmap_mode("view")
ttm()
ttm()
ttm()
ttm()
ttm()
ttm()
ttm()
ttm()
ttm()
qtm(SFhomes15_sf)
ttm()
qtm(SFhomes15_sf)
ttm()
tm_shape(SFhomes15_sf) + tm_dots(col="totvalue", size = 0.25)
ttm()
tm_shape(SFhomes15_sf) + tm_dots(col="totvalue", size = 0.25)
tracts
st_centroid(tracts)
tracts$geometry
#Read in from shapefile
SFhighways = st_read('./data', 'SFhighways')
#A short script to restore all loaded data from Part I
library(sf)
### SF HOMES
# Read in from CSV file
SFhomes <- read.csv('data/sf_properties_25ksample.csv',
stringsAsFactors = FALSE)
# subset the data
SFhomes15 <- subset(SFhomes, as.numeric(SalesYear) == 2015)
# convert to an `sf` object with a defined CRS (WGS84)
SFhomes15_sf <- st_as_sf(SFhomes15, coords = c('lon', 'lat'),
crs = 4326)
### BART STATIONS
#Read in from a CSV.
bart <- read.csv("./data/bart.csv", stringsAsFactors = F)
#Convert to sf object
bart_sf <- st_as_sf(bart, coords = c('X', 'Y'), crs = 4326)
### LANDMAKRS
#Read in from a CSV
landmarks <- read.csv("./data/landmarks.csv")
#Convert to sf
landmarks_sf = st_as_sf(landmarks, coords = c('X', 'Y'), crs = 3857)
#Reproject to lonlat
landmarks_lonlat = st_transform(landmarks_sf, st_crs(SFhomes15_sf))
### SF BOUNDARY
#Read in from shapefile
SFboundary <- st_read('./data', 'SFboundary')
### SF HIGHWAYS
#Read in from shapefile
SFhighways = st_read('./data', 'SFhighways')
#Transform to lonlat
SFhighways_lonlat = st_transform(SFhighways, st_crs(SFhomes15_sf))
### SF CENSUS TRACTS
#Read in from shapefile
tracts = st_read(dsn = './data', layer = 'sftracts')
#Transform to lonlat
tracts_lonlat = st_transform(tracts, crs = 4326)
library(tmap)
?tm_symbols
tm_shape(tracts) + tm_polygons(col="beige", border.col="red", alpha = 0.4)
ttm()
tm_shape(tracts) + tm_polygons(col="beige", border.col="red", alpha = 0.4)
ttm()
tmap_mode('view')
tm_shape(SFhighways_lonlat) + tm_lines(col="black")
# Map the SF Boundary first
overlay_map = tm_shape(SFboundary) +
tm_polygons(col="beige", border.col="black") +
# Overlay the highway lines next
tm_shape(SFhighways_lonlat) +
tm_lines(col="black") +
# Then add the house points
tm_shape(SFhomes15_sf) +
tm_dots(col="totvalue", size=.25)
5
x = 5
x
overlay_map
overlay_map =
tm_shape(landmarks_lonlat) +
tm_dots(col = 'skyblue', size = 2)
overlay_map
# Map the SF Boundary first
overlay_map = tm_shape(SFboundary) +
tm_polygons(col="beige", border.col="black") +
# Overlay the highway lines next
tm_shape(SFhighways_lonlat) +
tm_lines(col="black") +
# Then add the house points
tm_shape(SFhomes15_sf) +
tm_dots(col="totvalue", size=.25)
overlay_map
ttm()
overlay_map
overlay_map +
tm_shape(landmarks_lonlat) +
tm_dots(col = 'skyblue', size = 2)
x+4
landmarks_lonlat
overlay_map +
tm_shape(landmarks_sf) +
tm_dots(col = 'skyblue', size = 2)
landmarks_sf
SFhomes15_sf_low2high <- SFhomes15_sf[order(SFhomes15_sf$totvalue, decreasing = FALSE),]
SFhomes15_sf_high2low <- SFhomes15_sf[order(SFhomes15_sf$totvalue, decreasing = TRUE),]
SFhomes15_sf_low2high <- SFhomes15_sf[order(SFhomes15_sf$totvalue, decreasing = FALSE),]
SFhomes15_sf_high2low <- SFhomes15_sf[order(SFhomes15_sf$totvalue, decreasing = TRUE),]
high2low = tm_shape(SFhomes15_sf_high2low) +
tm_dots(col='totvalue', size=1)
low2high = tm_shape(SFhomes15_sf_low2high) +
tm_dots(col='totvalue', size=1)
tmap_arrange(high2low, low2high)
library(sf)     # spatial objects and methods
library(tmap)   # mapping spatial objects
source('./docs/reload_part_01_data.R')
#highways are already in 26910!
st_crs(SFhighways)
#highways are already in 26910!
st_crs(SFhomes15_sf)
#so we can use them as the target CRS
SFhomes15_utm <- st_transform(SFhomes15_sf, st_crs(SFhighways))
# Check the CRS
st_crs(SFboundary) == st_crs(SFhomes15_utm)
# Transform
SFboundary_utm <- st_transform(SFboundary, st_crs(SFhomes15_utm))
# Check again
st_crs(SFboundary_utm) == st_crs(SFhomes15_utm)
bart_utm = st_transform(bart, st_crs(SFhighways))
bart_utm = st_transform(bart, st_crs(SFhighways))
bart
bart_sf
bart_utm = st_transform(bart_sf, st_crs(SFhighways))
st_crs(bart_utm)$epsg
st_crs(SFboundary_utm)$epsg
st_crs(SFhighways)$epsg
st_crs(SFhomes15_utm)$epsg
str(st_crs(bart_utm))
st_crs(bart_utm)$epsg
plot(SFboundary_utm)
lines(SFhighways, col='purple', lwd=4)
points(SFhomes15_utm)
plot(bart_utm, col="red", pch=15, add=T)
plot(st_geometry(SFboundary_utm))
plot(st_geometry(SFhighways), col='purple', lwd=4, add = T)
plot(st_geometry(SFhomes15_utm), add = T, pch = 19, cex = 0.5)
plot(st_geometry(bart_utm), col="skyblue", pch=19, cex = 1, add=T)
plot(st_geometry(SFboundary_utm))
plot(st_geometry(SFhighways), col='purple', lwd=4, add = T)
plot(st_geometry(SFhomes15), add = T, pch = 19, cex = 0.5)
plot(st_geometry(bart_utm), col="skyblue", pch=19, cex = 1, add=T)
plot(st_geometry(SFhomes15_sf), add = T, pch = 19, cex = 0.5)
plot(st_geometry(bart_utm), col="skyblue", pch=19, cex = 1, add=T)
plot(st_geometry(SFhomes15_utm), add = T, pch = 19, cex = 0.5)
plot(st_geometry(bart_utm), col="skyblue", pch=19, cex = 1, add=T)
plot(SFboundary_utm)
lines(SFhighways, col='purple', lwd=4)
head(iris)
class(iris)
type(iris)
typeof(iris)
iris$Sepal.Length
?st_area
SF_area = st_area(SFboundary_utm)
SF_area
class(SF_area)
typeof(SF_area)
SF_area / (1000 * 1000) # Convert to square KM
library(units)
set_units(SF_area, km^2)
set_units(SF_area, KM^2)
set_units(SF_area, Km^2)
set_units(SF_area, km^2)
valid_udunits()
View(valid_udunits())
set_units(SF_area, Hz^2)
set_units(SF_area, sr^2)
set_units(SF_area, km^2)
st_area(SFboundary)
st_length(SFhighways)
head(SFhighways)
SFhighways
SFhighways$geometry[[1]]
sum(st_length(SFhighways))
set_units(sum(st_length(SFhighways)), km)
lwgeom::st_perimeter(tracts)
st_perimeter(tracts)
?st_distance
bart_utm
bart_utm$STATION
bart_utm$STATION == 'EMBARCADERO'
bart_utm[bart_utm$STATION == 'EMBARCADERO',]
bart_utm[bart_utm$STATION == 'POWELL STREET',]
st_distance(bart_utm[bart_utm$STATION == 'EMBARCADERO',],
bart_utm[bart_utm$STATION == 'POWELL STREET',])
homes2embarc = st_distance(bart_utm[30,],SFhomes15_utm)
homes2embarc
dim(homes2embarc)
dim(st_distance(SFhomes15_sf, bart_utm[30,])
_
dim(st_distance(SFhomes15_sf, bart_utm[30,]))
dim(st_distance(SFhomes15_utm, bart_utm[30,]))
?st_within
bart_stations_in_SF <-st_within(bart_utm, SFboundary_utm, sparse=F)
head(bart_stations_in_SF)
bart_stations_in_SF
T %in% bart_stations_in_sf
T %in% bart_stations_in_SF
sum(bart_stations_in_SF)
bart_utm[bart_stations_in_sf, c('STATION')]#STATION
bart_utm[bart_stations_in_SF, c('STATION')]#STATION
bart_utm[bart_stations_in_SF,]$STATION
sfbart_utm = st_intersection(bart_utm, SFboundary_utm)
sfbart_utm
tmap_mode("view")
tm_shape(SFboundary_utm) +
tm_polygons(col="beige", border.col="black") +
tm_shape(sfbart_utm) +
tm_dots(col="red")
sftracts = st_read(dsn='./data', layer='sftracts_wpop')
plot(sftracts['POP'])
head(sftracts)
plot(sftracts)
plot(sftracts['pop14'])
plot(sftracts['ALAND'])
plot(sftracts['pop14'])
homes_with_tracts <- st_within(SFhomes15_utm, sftracts)
# What is the CRS of the property data?
st_crs(SFhomes15_utm)
# What is the CRS of the census tracts?
st_crs(sftracts)
#transform to UTM
sftracts_utm = st_transform(sftracts, st_crs(SFhomes15_utm))
# make sure the CRSs are the same
st_crs(sftracts_utm) == st_crs(SFhomes15_utm)
homes_with_tracts <- st_within(SFhomes15_utm, sftracts_utm)
class(homes_with_tracts)
length(homes_with_tracts)
nrow(sftracts_utm)
nrow(SFhomes15_utm)
homes_with_tracts
?st_within
st_within(SFhomes15_utm, sftracts_utm)
st_within(SFhomes15_utm, sftracts_utm, sparse=F)
st_within(SFhomes15_utm, sftracts_utm)
head(homes_with_tracts)
unlist(homes_with_tracts)
sftracts_utm[unlist(homes_with_tracts),]
sftracts_utm[unlist(homes_with_tracts),]$GEOID
SFhomes15_utm$home_geoid <- sftracts_utm[unlist(homes_with_tracts),]$GEOID
head(SFhomes15_utm, 2)
join_map = tm_shape(sftracts_utm) +
tm_polygons() +
tm_shape(SFhomes15_utm) +
tm_dots(col = 'home_geoid', size = 0.25)
#Note that tmap bins our tracts because we have so many
join_map
med_hh_inc <- read.csv("data/sf_med_hh_income2015.csv", stringsAsFactors = F,
colClasses = c("character","numeric"))
head(med_hh_inc)
#make sure we're using `base` `merge` (because multiple other packages
#that you might have read in also have a `merge` function)
SFhomes15_utm <- base::merge(SFhomes15_utm,
med_hh_inc, by.x="home_geoid", by.y="GEOID")
head(SFhomes15_utm, 2) # Look for the col medhhinc
tmap_mode("view")
tm_shape(sftracts_utm) + tm_polygons() +
tm_shape(SFhomes15_utm) + tm_dots(col="medhhinc")
?sf::aggregate.sf
SFhomes15_utm["totvalue"]
tracts_with_mean_val <- aggregate(x = SFhomes15_utm["totvalue"],
by = sftracts_utm,
FUN = mean)
class(tracts_with_mean_val)
head(tracts_with_mean_val, 2)
nrow(tracts_with_mean_val) == nrow(sftracts_utm)
sftracts_utm$mean_totvalue <- tracts_with_mean_val$totvalue
head(sftracts_utm, 2) # check it
mean_totvalue_choropleth =
tm_shape(sftracts_utm) +
tm_polygons(col="mean_totvalue", border.col=NA)
mean_totvalue_choropleth
View(SFboundary)
